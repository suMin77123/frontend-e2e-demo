name: Visual Regression Testing

on:
  # PR ìƒì„± ë° ì—…ë°ì´íŠ¸ì‹œ ì‹¤í–‰
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]

# ê¶Œí•œ ì„¤ì • ì¶”ê°€
permissions:
  contents: read
  issues: write
  pull-requests: write
  
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    # ì›Œí¬í”Œë¡œìš° ì‹œì‘ ì‹œê°„ ì„¤ì •
    - name: Set workflow start time
      id: start_time
      run: |
        START_TIME=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
        echo "workflow_started_at=${START_TIME}" >> $GITHUB_OUTPUT
        echo "Started at: ${START_TIME}"
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --prefer-offline --no-audit --no-fund
      
    # ë¸Œëœì¹˜ëª… ì„¤ì •
    - name: Set branch name
      id: branch
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "branch_name=${{ github.head_ref }}" >> $GITHUB_OUTPUT
        else
          echo "branch_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        fi

    - name: Cache Playwright browsers
      uses: actions/cache@v4
      id: cache-playwright-browsers
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-browsers-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-playwright-browsers-

    - name: Cache Playwright system dependencies marker
      uses: actions/cache@v4
      id: cache-playwright-system-deps
      with:
        path: ~/.cache/playwright-deps-installed
        key: ${{ runner.os }}-playwright-deps-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-playwright-deps-

    - name: Install Playwright browsers
      if: steps.cache-playwright-browsers.outputs.cache-hit != 'true'
      run: npx playwright install
      
    - name: Install Playwright system dependencies
      if: steps.cache-playwright-system-deps.outputs.cache-hit != 'true'
      run: |
        npx playwright install-deps
        mkdir -p ~/.cache
        echo "$(date)" > ~/.cache/playwright-deps-installed
      
    - name: Run Playwright tests
      run: npx playwright test --reporter=html

    # ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ HTML ë¦¬í¬íŠ¸ ì—…ë¡œë“œ (2-up, Swipe, Onion Skin ì§€ì›)
    - name: Upload Playwright HTML Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
        
    - name: Upload visual comparison results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: visual-comparison-diffs
        path: |
          test-results/**/*.png
          test-results/**/*-diff.png
          test-results/**/*-actual.png
          test-results/**/*-expected.png
        retention-days: 30

    # MinIOì— ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
    - name: Cache MinIO Client
      if: always()
      uses: actions/cache@v4
      id: cache-minio-client
      with:
        path: /usr/local/bin/mc
        key: ${{ runner.os }}-minio-client
        restore-keys: |
          ${{ runner.os }}-minio-

    - name: Setup MinIO Client
      if: always() && steps.cache-minio-client.outputs.cache-hit != 'true'
      run: |
        wget https://dl.min.io/client/mc/release/linux-amd64/mc
        chmod +x mc
        sudo mv mc /usr/local/bin/
        echo "MinIO Client (mc) has been installed successfully!"

    - name: Upload to MinIO
      if: always()
      run: |
        mc alias set --insecure pia http://macs.pia.space:32702 ${{ secrets.MINIO_ACCESS_KEY }} ${{ secrets.MINIO_SECRET_KEY }}
        mc cp --recursive playwright-report pia/frontend-e2e-demo/${{ steps.branch.outputs.branch_name }}/${{ steps.start_time.outputs.workflow_started_at }}/
        mc cp --recursive test-results pia/frontend-e2e-demo/${{ steps.branch.outputs.branch_name }}/${{ steps.start_time.outputs.workflow_started_at }}/
        mc anonymous set download pia/frontend-e2e-demo/${{ steps.branch.outputs.branch_name }}/

    # PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
    - name: Comment PR with report link
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const branchName = '${{ steps.branch.outputs.branch_name }}';
          const startedAt = '${{ steps.start_time.outputs.workflow_started_at }}';
          const reportUrl = `http://macs.pia.space:32702/frontend-e2e-demo/${branchName}/${startedAt}/playwright-report/index.html`;
          
          const comment = `## ğŸ“¸ Visual Regression Test Report
          
          ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: [í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ë³´ê¸°](${reportUrl})
          
          ğŸ” ë¦¬í¬íŠ¸ì—ì„œ ë‹¤ìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
          - ìŠ¤í¬ë¦°ìƒ· ë¹„êµ ê²°ê³¼
          - ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ì˜ Before/After ë¹„êµ
          - Diff, Side-by-Side, Slider ë·° ì§€ì›
          
          ë¸Œëœì¹˜: \`${branchName}\`
          ë¦¬í¬íŠ¸ ìƒì„± ì‹œê°„: ${new Date(startedAt).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}
          
          âœ‹ğŸ» ì˜ë„ëœ ë³€ê²½ ì‚¬í•­ì´ë¼ë©´?
          Labelsì— \`Intended-Changes\` ë¼ë²¨ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });