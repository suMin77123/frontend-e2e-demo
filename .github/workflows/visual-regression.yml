name: Visual Regression Testing

on:
  # PR ìƒì„± ë° ì—…ë°ì´íŠ¸ì‹œ ì‹¤í–‰
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps

    - name: Install ImageMagick
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick
        convert -version
      
    - name: Run Playwright tests
      run: npx playwright test
        
    - name: Upload visual comparison results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: visual-comparison-report
        path: |
          test-results/**/*.png
          test-results/**/*-diff.png
        retention-days: 30

    - name: Generate Optimized Visual Report and Post PR Comment
      if: github.event_name == 'pull_request' && failure()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          const { execSync } = require('child_process');
          
          // ì´ë¯¸ì§€ ìµœì í™” í•¨ìˆ˜ (ImageMagick ì‚¬ìš©)
          function optimizeImage(inputPath, outputPath, maxWidth = 600, quality = 50) {
            try {
              console.log(`ì´ë¯¸ì§€ ìµœì í™” ì‹œë„: ${inputPath} -> ${outputPath}`);
              execSync(`convert "${inputPath}" -resize ${maxWidth}x -quality ${quality} -strip "${outputPath}"`, { stdio: 'inherit' });
              const success = fs.existsSync(outputPath);
              console.log(`ìµœì í™” ê²°ê³¼: ${success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`);
              return success;
            } catch (error) {
              console.error(`ì´ë¯¸ì§€ ìµœì í™” ì‹¤íŒ¨: ${inputPath} - ${error.message}`);
              return false;
            }
          }
          
          // Base64ë¡œ ì´ë¯¸ì§€ë¥¼ ì¸ì½”ë”©í•˜ëŠ” í•¨ìˆ˜
          function imageToBase64(imagePath) {
            if (!fs.existsSync(imagePath)) {
              console.log(`ì´ë¯¸ì§€ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: ${imagePath}`);
              return null;
            }
            try {
              const imageBuffer = fs.readFileSync(imagePath);
              const base64 = `data:image/png;base64,${imageBuffer.toString('base64')}`;
              console.log(`Base64 ì¸ì½”ë”© ì„±ê³µ: ${imagePath} (${Math.round(base64.length/1024)}KB)`);
              return base64;
            } catch (error) {
              console.error(`Base64 ì¸ì½”ë”© ì‹¤íŒ¨: ${imagePath} - ${error.message}`);
              return null;
            }
          }
          
          // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì°¾ê¸°
          function findTestResults() {
            const testResultsDir = 'test-results';
            const results = [];
            
            console.log(`í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë””ë ‰í† ë¦¬ í™•ì¸: ${testResultsDir}`);
            if (!fs.existsSync(testResultsDir)) {
              console.log('test-results ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
              return results;
            }
            
            const testDirs = fs.readdirSync(testResultsDir)
              .filter(dir => fs.statSync(path.join(testResultsDir, dir)).isDirectory());
            
            console.log(`ë°œê²¬ëœ í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ë“¤: ${testDirs.join(', ')}`);
            
            for (const testDir of testDirs) {
              const testPath = path.join(testResultsDir, testDir);
              const files = fs.readdirSync(testPath);
              
              console.log(`${testDir} ë””ë ‰í† ë¦¬ì˜ íŒŒì¼ë“¤: ${files.join(', ')}`);
              
              const screenshots = files.filter(file => 
                file.endsWith('.png') && !file.includes('-previous') && !file.includes('-diff')
              );
              
              for (const screenshot of screenshots) {
                const baseName = screenshot.replace('.png', '');
                const expectedPath = path.join('e2e', `${testDir}.test.ts-snapshots`, screenshot);
                const actualPath = path.join(testPath, screenshot);
                const diffPath = path.join(testPath, `${baseName}-diff.png`);
                
                console.log(`ìŠ¤í¬ë¦°ìƒ· ë¶„ì„:`);
                console.log(`  - Expected: ${expectedPath} (ì¡´ì¬: ${fs.existsSync(expectedPath)})`);
                console.log(`  - Actual: ${actualPath} (ì¡´ì¬: ${fs.existsSync(actualPath)})`);
                console.log(`  - Diff: ${diffPath} (ì¡´ì¬: ${fs.existsSync(diffPath)})`);
                
                const hasDiff = fs.existsSync(diffPath);
                
                if (hasDiff || !fs.existsSync(expectedPath)) {
                  results.push({
                    testName: `${testDir} - ${baseName}`,
                    expectedPath: fs.existsSync(expectedPath) ? expectedPath : null,
                    actualPath: actualPath,
                    diffPath: hasDiff ? diffPath : null,
                    hasChanges: true
                  });
                  console.log(`ë³€ê²½ì‚¬í•­ ì¶”ê°€: ${testDir} - ${baseName}`);
                }
              }
            }
            
            return results;
          }
          
          // ê°„ë‹¨í•œ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ HTML ìƒì„± (JavaScript ì—†ìŒ)
          function generateInteractiveHTML(testResult, index) {
            console.log(`\n=== ${testResult.testName} HTML ìƒì„± ì‹œì‘ ===`);
            
            // ìµœì í™”ëœ ì´ë¯¸ì§€ ë””ë ‰í† ë¦¬ ìƒì„±
            const optimizedDir = 'optimized-images';
            if (!fs.existsSync(optimizedDir)) {
              fs.mkdirSync(optimizedDir, { recursive: true });
              console.log(`ìµœì í™” ë””ë ‰í† ë¦¬ ìƒì„±: ${optimizedDir}`);
            }
            
            // ì´ë¯¸ì§€ ìµœì í™” ë° Base64 ì¸ì½”ë”©
            let expectedBase64 = null;
            let actualBase64 = null;
            let diffBase64 = null;
            
            if (testResult.expectedPath) {
              const expectedOptimized = path.join(optimizedDir, `expected-${index}.png`);
              if (optimizeImage(testResult.expectedPath, expectedOptimized)) {
                expectedBase64 = imageToBase64(expectedOptimized);
              }
            }
            
            if (testResult.actualPath) {
              const actualOptimized = path.join(optimizedDir, `actual-${index}.png`);
              if (optimizeImage(testResult.actualPath, actualOptimized)) {
                actualBase64 = imageToBase64(actualOptimized);
              }
            }
            
            if (testResult.diffPath) {
              const diffOptimized = path.join(optimizedDir, `diff-${index}.png`);
              if (optimizeImage(testResult.diffPath, diffOptimized)) {
                diffBase64 = imageToBase64(diffOptimized);
              }
            }
            
            console.log(`Base64 ê²°ê³¼:`);
            console.log(`  - Expected: ${expectedBase64 ? 'OK' : 'FAIL'}`);
            console.log(`  - Actual: ${actualBase64 ? 'OK' : 'FAIL'}`);
            console.log(`  - Diff: ${diffBase64 ? 'OK' : 'FAIL'}`);
            
            if (!actualBase64) {
              console.log('ì‹¤ì œ ì´ë¯¸ì§€ê°€ ì—†ì–´ì„œ HTML ìƒì„± ê±´ë„ˆëœ€');
              return '';
            }
            
            // ê°„ë‹¨í•œ HTML ìƒì„±
            let html = '';
            html += '<details>\n';
            html += '<summary><strong>ğŸ–¼ï¸ ' + testResult.testName + '</strong></summary>\n\n';
            
            // ë‚˜ë€íˆ ë¹„êµ
            html += '<h4>ğŸ“Š ë‚˜ë€íˆ ë¹„êµ</h4>\n';
            html += '<table style="width: 100%; border-collapse: collapse;">\n';
            html += '<tr>\n';
            
            if (expectedBase64) {
              html += '<td style="width: 50%; text-align: center; padding: 10px; vertical-align: top;">\n';
              html += '<h5 style="color: #28a745;">âœ… ì˜ˆìƒ ê²°ê³¼ (Expected)</h5>\n';
              html += '<img src="' + expectedBase64 + '" style="max-width: 100%; border: 2px solid #28a745; border-radius: 4px;" alt="Expected">\n';
              html += '</td>\n';
            }
            
            html += '<td style="width: 50%; text-align: center; padding: 10px; vertical-align: top;">\n';
            html += '<h5 style="color: #d73a49;">ğŸ”´ ì‹¤ì œ ê²°ê³¼ (Actual)</h5>\n';
            html += '<img src="' + actualBase64 + '" style="max-width: 100%; border: 2px solid #d73a49; border-radius: 4px;" alt="Actual">\n';
            html += '</td>\n';
            html += '</tr>\n';
            html += '</table>\n\n';
            
            // ì°¨ì´ì  í‘œì‹œ
            if (diffBase64) {
              html += '<h4>âš¡ ì°¨ì´ì  í•˜ì´ë¼ì´íŠ¸</h4>\n';
              html += '<div style="text-align: center; margin: 20px 0;">\n';
              html += '<img src="' + diffBase64 + '" style="max-width: 100%; border: 2px solid #f39c12; border-radius: 4px;" alt="Difference">\n';
              html += '<p><em>ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œëœ ì˜ì—­ì´ ë³€ê²½ëœ ë¶€ë¶„ì…ë‹ˆë‹¤.</em></p>\n';
              html += '</div>\n\n';
            }
            
            // ì „í›„ ë¹„êµ (ì„¸ë¡œ ë°°ì¹˜)
            if (expectedBase64) {
              html += '<h4>ğŸ”„ ì „í›„ ë¹„êµ</h4>\n';
              html += '<div style="text-align: center;">\n';
              
              html += '<div style="margin-bottom: 20px;">\n';
              html += '<h5 style="color: #28a745;">ğŸ‘† ë³€ê²½ ì „ (Expected)</h5>\n';
              html += '<img src="' + expectedBase64 + '" style="max-width: 100%; border: 2px solid #28a745; border-radius: 4px; opacity: 0.8;" alt="Before">\n';
              html += '</div>\n';
              
              html += '<div style="margin: 20px 0; font-size: 24px;">â¬‡ï¸</div>\n';
              
              html += '<div>\n';
              html += '<h5 style="color: #d73a49;">ğŸ‘‡ ë³€ê²½ í›„ (Actual)</h5>\n';
              html += '<img src="' + actualBase64 + '" style="max-width: 100%; border: 2px solid #d73a49; border-radius: 4px;" alt="After">\n';
              html += '</div>\n';
              html += '</div>\n\n';
            } else {
              html += '<div style="background: #fff3cd; padding: 12px; border-radius: 4px; border-left: 4px solid #ffc107; margin: 15px 0;">\n';
              html += 'âš ï¸ <strong>ìƒˆë¡œìš´ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤:</strong> ê¸°ì¡´ ìŠ¤í¬ë¦°ìƒ·ì´ ì—†ìŠµë‹ˆë‹¤.\n';
              html += '</div>\n';
            }
            
            html += '</details>\n';
            
            console.log(`HTML ìƒì„± ì™„ë£Œ (ê¸¸ì´: ${html.length}ì)`);
            return html;
          }
          
          // ë©”ì¸ ì‹¤í–‰
          console.log('ğŸ” í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì°¾ëŠ” ì¤‘...');
          const testResults = findTestResults();
          
          if (testResults.length === 0) {
            console.log('âœ… ì‹œê°ì  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤!');
            
            // ì„±ê³µ ë©”ì‹œì§€ ëŒ“ê¸€ ìƒì„±
            const successComment = `## ğŸ­ Visual Regression Report

          âœ… **ëª¨ë“  ì‹œê°ì  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤!**

          ğŸ“‹ **ì„¸ë¶€ ì •ë³´:**
          - ì»¤ë°‹: \`${context.sha.substring(0, 7)}\`
          - ê²€ì‚¬ ì‹œê°„: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}

          ---
          *ì´ ëŒ“ê¸€ì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`;
          
            // ê¸°ì¡´ ëŒ“ê¸€ ì°¾ê¸° ë° ì—…ë°ì´íŠ¸/ìƒì„±
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.body.includes('ğŸ­ Visual Regression Report') &&
              comment.user.login === 'github-actions[bot]'
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: successComment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: successComment
              });
            }
            
            return;
          }
          
          console.log(`ğŸ“¸ ${testResults.length}ê°œì˜ ì‹œê°ì  ë³€ê²½ì‚¬í•­ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.`);
          
          const commitSha = context.sha.substring(0, 7);
          const runId = context.runId;
          const artifactUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
          
          let commentBody = `## ğŸ­ Visual Regression Report

          âš ï¸ **${testResults.length}ê°œì˜ ì‹œê°ì  ë³€ê²½ì‚¬í•­ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.**

          ğŸ“‹ **ì„¸ë¶€ ì •ë³´:**
          - ì»¤ë°‹: \`${commitSha}\`
          - ê²€ì‚¬ ì‹œê°„: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}

          ## ğŸ“¸ ë³€ê²½ëœ ìŠ¤í¬ë¦°ìƒ·

          ê° í•­ëª©ì„ í´ë¦­í•˜ë©´ **ë‚˜ë€íˆ ë¹„êµ**, **ì°¨ì´ì  í•˜ì´ë¼ì´íŠ¸**, **ì „í›„ ë¹„êµ** í˜•íƒœë¡œ ì´ë¯¸ì§€ ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

          `;
          
          // ê° í…ŒìŠ¤íŠ¸ ê²°ê³¼ì— ëŒ€í•œ HTML ìƒì„±
          let totalHtmlLength = 0;
          testResults.forEach((result, index) => {
            console.log(`\nìµœì í™”ëœ ì´ë¯¸ì§€ ìƒì„± ì¤‘: ${result.testName}`);
            const html = generateInteractiveHTML(result, index);
            commentBody += html;
            totalHtmlLength += html.length;
            console.log(`í˜„ì¬ ì´ HTML ê¸¸ì´: ${totalHtmlLength}ì`);
          });
          
          commentBody += `

          ## ğŸ“ ë‹¤ìš´ë¡œë“œ

          [ğŸ“¦ ì „ì²´ Visual Report ë° ì›ë³¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ](${artifactUrl})

          > ğŸ’¡ **ì‚¬ìš©ë²•**: 
          > - ğŸ“Š **ë‚˜ë€íˆ ë¹„êµ**: ì˜ˆìƒ ê²°ê³¼ì™€ ì‹¤ì œ ê²°ê³¼ë¥¼ ë‚˜ë€íˆ í™•ì¸
          > - âš¡ **ì°¨ì´ì  í•˜ì´ë¼ì´íŠ¸**: ë³€ê²½ëœ ë¶€ë¶„ì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ
          > - ğŸ”„ **ì „í›„ ë¹„êµ**: ë³€ê²½ ì „ê³¼ í›„ì˜ ëª¨ìŠµì„ ìœ„ì•„ë˜ë¡œ ë°°ì¹˜
          > 
          > ğŸ“ **ì°¸ê³ **: ëŒ“ê¸€ í¬ê¸° ì œí•œìœ¼ë¡œ ì¸í•´ ì´ë¯¸ì§€ í’ˆì§ˆì´ ìµœì í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì›ë³¸ ê³ í™”ì§ˆ ì´ë¯¸ì§€ëŠ” ìœ„ ë§í¬ì—ì„œ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.

          ---
          *ì´ ëŒ“ê¸€ì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`;
          
          console.log(`\nìµœì¢… ëŒ“ê¸€ ê¸¸ì´: ${commentBody.length}ì`);
          
          // ê¸°ì¡´ ëŒ“ê¸€ ì°¾ê¸°
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const existingComment = comments.find(comment => 
            comment.body.includes('ğŸ­ Visual Regression Report') &&
            comment.user.login === 'github-actions[bot]'
          );
          
          if (existingComment) {
            // ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: commentBody
            });
            console.log('âœ… ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
          } else {
            // ìƒˆ ëŒ“ê¸€ ìƒì„±
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
            console.log('âœ… ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
          } 