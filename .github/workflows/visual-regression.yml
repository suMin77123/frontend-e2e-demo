name: Visual Regression Testing

on:
  # PR ìƒì„± ë° ì—…ë°ì´íŠ¸ì‹œ ì‹¤í–‰
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]
  # main ë¸Œëœì¹˜ pushì‹œ ì‹¤í–‰
  push:
    branches: [ main ]

# ê¶Œí•œ ì„¤ì • ì¶”ê°€
permissions:
  contents: read
  issues: write
  pull-requests: write
  
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Install dependencies
      run: npm ci
      
    # ë¸Œëœì¹˜ëª… ì„¤ì •
    - name: Set branch name
      id: branch
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "branch_name=${{ github.head_ref }}" >> $GITHUB_OUTPUT
        else
          echo "branch_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        fi

    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Run Playwright tests
      run: npx playwright test --reporter=html

    # ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ HTML ë¦¬í¬íŠ¸ ì—…ë¡œë“œ (2-up, Swipe, Onion Skin ì§€ì›)
    - name: Upload Playwright HTML Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
        
    - name: Upload visual comparison results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: visual-comparison-diffs
        path: |
          test-results/**/*.png
          test-results/**/*-diff.png
          test-results/**/*-actual.png
          test-results/**/*-expected.png
        retention-days: 30

    # MinIOì— ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
    - name: Setup MinIO Client
      if: always()
      run: |
        wget https://dl.min.io/client/mc/release/linux-amd64/mc
        chmod +x mc
        sudo mv mc /usr/local/bin/
        echo "MinIO Client (mc) has been installed successfully!"

    - name: Upload to MinIO
      if: always()
      run: |
        mc alias set --insecure pia http://macs.pia.space:32702 ${{ secrets.MINIO_ACCESS_KEY }} ${{ secrets.MINIO_SECRET_KEY }}
        mc rm --recursive --force pia/frontend-e2e-demo/${{ steps.branch.outputs.branch_name }}/
        mc cp --recursive playwright-report/ pia/frontend-e2e-demo/${{ steps.branch.outputs.branch_name }}/
        if [ -d "test-results" ]; then
          mc cp --recursive test-results/**/*.png pia/frontend-e2e-demo/${{ steps.branch.outputs.branch_name }}/
        fi
        mc anonymous set download pia/frontend-e2e-demo/${{ steps.branch.outputs.branch_name }}/

    # PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
    - name: Comment PR with report link
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const branchName = '${{ steps.branch.outputs.branch_name }}';
          const reportUrl = `http://macs.pia.space:32702/frontend-e2e-demo/${branchName}/index.html`;
          
          const comment = `## ğŸ“¸ Visual Regression Test Report
          
          ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: [í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ë³´ê¸°](${reportUrl})
          
          ğŸ” ë¦¬í¬íŠ¸ì—ì„œ ë‹¤ìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
          - ìŠ¤í¬ë¦°ìƒ· ë¹„êµ ê²°ê³¼
          - ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ì˜ Before/After ë¹„êµ
          - 2-up, Swipe, Onion Skin ë·° ì§€ì›
          
          ë¸Œëœì¹˜: \`${branchName}\``;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });