name: Cleanup MinIO Artifacts

on:
  pull_request:
    types: [closed]
  workflow_dispatch:

jobs:
  cleanup-minio-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Set branch name
        id: branch
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "branch_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "branch_name=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Cache MinIO Client
        uses: actions/cache@v4
        id: cache-minio-client
        with:
          path: /usr/local/bin/mc
          key: ${{ runner.os }}-minio-client

      - name: Setup MinIO Client
        if: steps.cache-minio-client.outputs.cache-hit != 'true'
        run: |
          wget https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc
          sudo mv mc /usr/local/bin/
          echo "MinIO Client (mc) has been installed successfully!"

      - name: Cleanup MinIO Artifacts
        run: |
          mc alias set --insecure pia http://macs.pia.space:32702 ${{ secrets.MINIO_ACCESS_KEY }} ${{ secrets.MINIO_SECRET_KEY }}
          mc rm --recursive --force pia/frontend-e2e-demo/${{ steps.branch.outputs.branch_name }}